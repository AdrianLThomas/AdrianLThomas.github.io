{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/blog/2025-03-17/reading-my-water-meter-in-home-assistant/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Adrian L Thomas"}},"markdownRemark":{"id":"02f68190-7ca3-5092-a4bb-384e05a9ddb8","excerpt":"Water bills in the UK are going up, again, and I thought it would be nice to keep a closer eye on the household usage by integrating the water meter in to Home…","html":"<p>Water bills in the UK <a href=\"https://www.bbc.co.uk/news/articles/c5yd9qzx79go\">are going up, again</a>, and I thought it would be nice to keep a closer eye on the household usage by integrating the water meter in to <a href=\"https://www.home-assistant.io/\">Home Assistant</a>.</p>\n<h1>What I wanted to do</h1>\n<p>I wanted the water meter readings in Home Assistant so perhaps I could set up alerts and generally try to reduce how much water was being used (and identify when/where it gets used the most).</p>\n<h2>Setting up HA (Home Assistant)</h2>\n<p>I already had Home Assistant set up, but it’s simple enough to get started if you’re already self hosting things <a href=\"https://www.home-assistant.io/installation/linux#docker-compose\">with Docker</a> (e.g. homelab, raspberry pi or an off the shelf device). There’s quite a <a href=\"https://www.home-assistant.io/installation/\">few options available</a>.</p>\n<h1>The Solution</h1>\n<p>The solution for you could well differ from mine, there’s a ton of <a href=\"https://www.home-assistant.io/docs/energy/water/\">options documented to read your water meter</a>, but in my case I had an Irton EverBlu Cyble water meter, that as far as I know is fairly common in the UK. So the first step would be identify what you have so that you can work out how to read it.</p>\n<p>I came <a href=\"https://community.home-assistant.io/t/reading-itron-everblu-cyble-rf-enhanced-water-meter-with-esp32-esp8266-and-433mhz-cc1101-home-assistant-mqtt-autodiscovery/833180\">across this post on the HA forum</a> describing a solution for reading my meter using a 433MHz transceiver (the same way the water company reads the meter from the van outside your house).</p>\n<p>I already had some spare ESP8266’s around, so just needed a CC1101 transceiver which only cost a few quid off Amazon.</p>\n<h2>ESP.. what?</h2>\n<p>The ESP8266 is a very cheap microcontroller (as in only a few pounds), with built in WiFi.</p>\n<p>They’re not very powerful (80-160MHz), but for most IoT projects they don’t need to be. If you’ve ever used an Arduino or used the SPI pins on a Raspberry Pi, you’ll feel right at home.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a092bc88a280b8738e2218978499186f/29114/esp8266.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAADW0lEQVQ4yz2Q209bBRzHz5/gw14EyyCbAV3GaJBqAkMYrFwsaxGMEViwGZBNszkyZdwGzGDHZUCht9PL6WnP6Tmnpz29UDpn9MEXfTM++KBPmphooib+DR/Tmuzh8/r5fn4/oXRapVx5RqF4SuXsOdUvv6FaKeLf3eDe3Ts8Wl+lVK5QrX5FqVR5gWWVyOUL5HIFdCOHppsoqoZQLJ9RLFcolirkrDLhk32+NnwYcR/ffVshdLjJ/NyHmPkCZ9XnWIVSfTxvFcmaecycha6baFoWRdEQCrW14ilWscz6xjrX+rrZ2fiYP377kX//+pm/f/8BUz1h7tYMiqrWpbWymlA3zLo0oxmoqk4qpSLkCmXMXKEu9e3u4nINc8PZxecrC/zz50/8+sv3PFpawD3ah+ddN4FQkNOzZ3WRZpgY2RxqxkBRdWS5JrTK6KZFNl9E0U0Gr1/D6RxkqK+T+ZseerodnDv3ElNT7+HxjDEw2M/e/l797zWRqhmkVZ2krCIlFQTTKqFla2s5pFSGqekZmpubGBoeoqfrCh8Md+KdHsduv4Lb7cI19g5djjdYXVutV9bKaiSTCpKkIGimhaJlSak68WSapeU1HI43sTXZGHEOMDNi5/3xUSYmJ7Hb27n46gVGRod5u7eb5YefoWomcipDPJEiGpMR9KyFkjFIZ/S6NBAMc++TRTo7O2loeJmevgFcbjcTE+N0dLTj9c6QSARxjTpZXVt7cW48niIWSyFkjDzJlEo683+lGJN4enDEnY/ucvlyO83nbfT39+FyuVj69D6+7XW2NpfxeNzsH/gJiwliiTSimCQiSggZzSQpK6hatk5CkgmFRPb2D5ibv01raystLU10Obro6+3m0mut2Gw2eq9eZWVlDf9xqH5qJCIRDMUQkmmdaFxGVgxkRScWlwlHYpwEImx/scP0zCxtbW2cb2rAZmvklcZGLl5o4cbYGJtb2xwcBgiFE3UCgSiCouhIUopMJouqGiSlNIm4TCwqEQxE8G3v4J29xVsOB+2XXsfe0c6w8zqL9xd5un/MyXGEYDCGGJEIBEQEUUwQCIrIaYOknCEciRMMioSCUfxHQXaf7LGxvsXC/G0mJybwznp58OAhjx/7ODwK4T8WOT6JEggleLLr5z9HrZVt5gvYhgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"a picture of an ESP8266\"\n        title=\"ESP8266\"\n        src=\"/static/a092bc88a280b8738e2218978499186f/f058b/esp8266.png\"\n        srcset=\"/static/a092bc88a280b8738e2218978499186f/c26ae/esp8266.png 158w,\n/static/a092bc88a280b8738e2218978499186f/6bdcf/esp8266.png 315w,\n/static/a092bc88a280b8738e2218978499186f/f058b/esp8266.png 630w,\n/static/a092bc88a280b8738e2218978499186f/40601/esp8266.png 945w,\n/static/a092bc88a280b8738e2218978499186f/78612/esp8266.png 1260w,\n/static/a092bc88a280b8738e2218978499186f/29114/esp8266.png 1920w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>CC1.. what?</h2>\n<p>I didn’t know much about the CC1101 until recently either. It’s described as a low-cost sub-1 GHz transceiver designed for very low-power wireless applications.</p>\n<p>Basically, you can use it to wirelessly read data from your meter.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7fb6c970300cc3c1966716930447de4c/73caa/cc1101.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.62025316455697%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAADQElEQVQ4y2WT70+TVxiG+we4Dzg1EraoiWFxmTJISBY+EGEd26omUzM1mcFlZFMww8GCdAWsVAGVKBARtBOwP3Q6ZlwLImDmJiDSlrlhZ0SdKGIpRNE6aIvt+76Xabu3dNmdnJwP55wr93nu51EQkiQhSVJ0Dy1RDC0xdEisZgV4PDVDm/0ehy0Ovqi10nbNGT4TRBFFhPfvI0mGzEmQ4NmMH+cDN90DTnr6rlFrtLK29DSZ+UdR5VbxdVUzT15Mh+8rpBhXMng2EOSv0Sn+Hhnhcr+N5gsWNuua+eZAC0fq9OzU1vOl7ns+KqwnY2sRWV9VYmi/KgNjHUl0226wTd+Pau9P9NiuM+sZ41OdkcTtenT1Z/hwx0HeTl1N2ntprMrWkZ5XzbrcCr6tNuF+8jzy5WAgwEu/F6/Hxd3Bc+yvOcKOksOs1Rg4cNJKltrM+vIzaGuaUVcbUH68gfRMFamf7SGnwsSaghrSik+Re7wdxdOxQabuW3jx0Mo/7gEmhy9iOFZOwXc6ciubUBUbyK82U1hzHmWxkQ3l59i2t4WcfS0k5ul5X9PClkOn0ZraaR/4A8Wjvipu/VpL/4+76TQU0tpQwM+nSjAfLafs0DHWl55gfOwOvXYHb23X80ZOI2vKjFSYO7D0OLg16gIpGIovUsP7vY30ni3E0VbGI+d5ZsYHsF85ySeaBt7deZxMjZnfbHau223UtXbROzTMtM8brbpvehq743f2Vx7EYr2I4qX3OYLPDdJspE0EETHgpe6Sg1LTZVqv3sA58pigIIcnMnz7DmbzD+TnF6BSrWPlyiQWL45nxYp3IqFEMxbFaOuIwlz6k+5xurq62aPVsXHjJlJSUlm6dBkLFiwiLm4+8fEJJCensLtILffhHCikgH8KRBdGQxObNm8lPT2D5csTSUh4k7i418OgJUuWoVRmoVZr6OzsZGJiIlLD2EkRhSBPH/bhGb2A524ju3I+YN5r81m4cFHYRVJSMtnZn9PQ0MjQ0E38fv9/pkqMHT0ZOnHTzC9ni2jSKtHmrSYjM4uSklI6Oi5FXcQqGAwiCEIYFmJEayhPjMf1J/dsJm4PdjDpGsHn+7+LEEQGyEbk/RVlVHdokwvwbAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"a picture of the CC1101 transceiver that operates at 433MHz\"\n        title=\"CC1101 transceiver - 433MHz\"\n        src=\"/static/7fb6c970300cc3c1966716930447de4c/f058b/cc1101.png\"\n        srcset=\"/static/7fb6c970300cc3c1966716930447de4c/c26ae/cc1101.png 158w,\n/static/7fb6c970300cc3c1966716930447de4c/6bdcf/cc1101.png 315w,\n/static/7fb6c970300cc3c1966716930447de4c/f058b/cc1101.png 630w,\n/static/7fb6c970300cc3c1966716930447de4c/40601/cc1101.png 945w,\n/static/7fb6c970300cc3c1966716930447de4c/73caa/cc1101.png 1110w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>MQTT</h2>\n<p>We’ll be using <a href=\"https://mqtt.org/\">MQTT</a> for this. It is a lightweight message queue, commonly used for IoT. We can publish the state of the water meter to it, and Home Assistant will subscribe to these updates accordingly.</p>\n<h1>Getting started</h1>\n<p>So if you want to follow along, I’m making the following assumptions:</p>\n<ol>\n<li>You have the same water meter as me</li>\n<li>You have Home Assistant set up and running</li>\n<li>You have an ESP8266</li>\n<li>You have a CC1101</li>\n</ol>\n<h1>Wiring up the CC1101 to the ESP8266</h1>\n<p>When you buy a component like the CC1101 you normally get a pin out diagram, either from the manufacturer or you can find one online, that looks something like this:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f9ad159960a5ce7135e74808de42eeec/d7542/cc1101-pinout.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.9367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADeklEQVQ4y42S229UVRSH5z8x0UexfeBRookomhiBhsIDiZo0Jj7oixHx3fgiGmLBXuiF0kZaK1q1NcSodNoZKYkQIBa0l6mZmTM9cylzbjNz7mc+s850aqFqXMnK3vuc3/r2b+29E91HnuTrry6wdP0HUotzpFJzLCzMMn9thuT8N6QWZ0ktfsfiwrck52dIp2b5JT1HOj0X60W7uDBLOvU9lz/vJ3G8qwNFyfBolCsm5bKJ57fWfgCa7vFfoWkGie6uTjKZ5fiD5zlUq1XKJZWt/MdUlVNUldNoyrtohVPom6epKu+hKW9TUT7DdSPCwMN1HBzbjhkxcGPj3vYeTR48qJLLrlNXX8MtvYxffgb0faB3grUPrE7QH6deehMnalVFUROtWsVzPQE+RSZzj2YTTEPH83x0vYKh9GAXD+MUD1HP7qe0eoA/bj/P73deQl15muXkUTLXh7g6+QGVYg7bdmKnieMC3HZomYaYxHNq6EoPjeJhbPVFln49wvTVV5meOcGPPx9j9e5z3PzyAMtDPUy8/wrF7Cq27baA3V0dOy2HQUAzbOI0DMzCSdziC6ysHWVl7SDJW93cufssxVwHbD1B8c/XqbvSLgR+gK5p+J5P4sSx/eTya60TjJqxwyDwqZUvoFXOoKq9lIofklwe5Pb9d1hZf4tN5Q20rfGHbjgMWgeaOHTwMW7c+ImtrRKqmqdYVCgU8mRzKtl8iY18mSs3C0wnl5hLX+HarRnur/9GLqeyWcjGNepmnlKpQLlUIDEy/BFTk/1MTQ4wPHKW0YvnGB7tZWS0l4tj5xgcOkv/8Kf0DZxhYOgTxsbOMzE+yKVLfYyP9zExfp7JywN8MTUYZ2K3bcuq0Wg41OsN6rUGQRBiGCa+62HoJrpuEvhh/BJ8P8D3Q1zXf6j1RBgGRFGIjE15O4Dj2IRhuLOW//Lga7Ua9bpkHcsysSwL0zTxPI8oimJd4u+iaAfiOE7sTtZBEBCFYQyTYkmr1oKKrtFoxLr4UpvNvUAJEQlIdpa5aNrA2rYr3/dj/e5O/hXoum68FqBkGyhtijPbtuNRUjYU7V7g9m4SUvAoUM7LMIwY3Aa04x8dhruAtV1nJHDRSJu6rqNpWuyq3ZXk/wIKSIAyF424E5ikzNtn1849QBnFlTiRgvaTaM/FnaRhiEu9dduWFV/ebuBfy1Je2bLknisAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"a diagram of the CC1101 pinout\"\n        title=\"CC1101 pin out\"\n        src=\"/static/f9ad159960a5ce7135e74808de42eeec/f058b/cc1101-pinout.png\"\n        srcset=\"/static/f9ad159960a5ce7135e74808de42eeec/c26ae/cc1101-pinout.png 158w,\n/static/f9ad159960a5ce7135e74808de42eeec/6bdcf/cc1101-pinout.png 315w,\n/static/f9ad159960a5ce7135e74808de42eeec/f058b/cc1101-pinout.png 630w,\n/static/f9ad159960a5ce7135e74808de42eeec/d7542/cc1101-pinout.png 810w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The code we’re going to use provided this mapping table; so attach the CC1101 accordingly:</p>\n<table>\n<thead>\n<tr>\n<th><strong>CC1101</strong></th>\n<th><strong>ESP8266</strong></th>\n<th><strong>Notes</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>VCC</td>\n<td>3V3</td>\n<td>Connect to the 3.3V power pin.</td>\n</tr>\n<tr>\n<td>GDO0</td>\n<td>D1</td>\n<td>General-purpose digital output.</td>\n</tr>\n<tr>\n<td>CSN</td>\n<td>D8</td>\n<td>SPI chip select; Feather has GPIO15 as CS.</td>\n</tr>\n<tr>\n<td>SCK</td>\n<td>D5</td>\n<td>SPI clock pin; SPI SCK maps to GPIO14.</td>\n</tr>\n<tr>\n<td>MOSI</td>\n<td>D7</td>\n<td>SPI MOSI pin; maps to GPIO13 on the Feather.</td>\n</tr>\n<tr>\n<td>GDO1 (MISO)</td>\n<td>D6</td>\n<td>SPI MISO pin; maps to GPIO12 on the Feather.</td>\n</tr>\n<tr>\n<td>GDO2</td>\n<td>D2</td>\n<td>Another general-purpose digital output.</td>\n</tr>\n<tr>\n<td>GND</td>\n<td>G</td>\n<td>Connect to ground.</td>\n</tr>\n</tbody>\n</table>\n<p><em>The original table can be found in the source repository <code class=\"language-text\">README.md</code></em></p>\n<p>You should then end up with something like this:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/641670381f7044dc246af484b1b3d2e8/2c3a2/esp8266-wired-up.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 104.43037974683544%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAVABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAEDBAUG/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAcFdA1IJ0FYVrBUf/8QAHhAAAQMEAwAAAAAAAAAAAAAAAQACAwQQERMSIjH/2gAIAQEAAQUCXltEi0uCd1OEYQ41LeEn/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAGxAAAgIDAQAAAAAAAAAAAAAAABEBEAIxYZH/2gAIAQEABj8CvRM5L22xcP/EABoQAQADAQEBAAAAAAAAAAAAAAEAETEhQRD/2gAIAQEAAT8huPVO/B7oWZ2Yw9YwPpcKxAl3yARp1k//2gAMAwEAAgADAAAAECjvgv/EABgRAAMBAQAAAAAAAAAAAAAAAAABMRAR/9oACAEDAQE/EHc4h0//xAAXEQADAQAAAAAAAAAAAAAAAAAAARAR/9oACAECAQE/EEZEf//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQVFh/9oACAEBAAE/EC2GvUb0XE+wWtYK0cQNX9YowRrqXLxFeQbg55DoynDCpSKJsntZ/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"esp8266 wired up to a cc1101\"\n        title=\"esp8266 wired up to a cc1101\"\n        src=\"/static/641670381f7044dc246af484b1b3d2e8/828fb/esp8266-wired-up.jpg\"\n        srcset=\"/static/641670381f7044dc246af484b1b3d2e8/ff44c/esp8266-wired-up.jpg 158w,\n/static/641670381f7044dc246af484b1b3d2e8/a6688/esp8266-wired-up.jpg 315w,\n/static/641670381f7044dc246af484b1b3d2e8/828fb/esp8266-wired-up.jpg 630w,\n/static/641670381f7044dc246af484b1b3d2e8/0ede0/esp8266-wired-up.jpg 945w,\n/static/641670381f7044dc246af484b1b3d2e8/3ac88/esp8266-wired-up.jpg 1260w,\n/static/641670381f7044dc246af484b1b3d2e8/2c3a2/esp8266-wired-up.jpg 1402w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1>Problem 1: How do we compile this thing?</h1>\n<p>OK so going back to the original forum post, the code takes us to <a href=\"https://github.com/genestealer/everblu-meters-esp8266-improved\">this repository</a> that is a fork of some older code. I had some issues (documentation and code changes), so of course I forked the fork, and you can <a href=\"https://github.com/AdrianLThomas/everblu-meters-esp8266-improved\">find it here</a>. This fork will remain the basis of what I refer to for the rest of the blog post.</p>\n<p><em>I raised a PR for the original maintainer, but at the time of writing it hasn’t yet been merged.</em></p>\n<p>Previously when tinkering with the ESP8266 I just used the Arduino IDE - it’s fairly straightforward to get up and running. You write some C, compile, upload, and away you go. I’d also used <a href=\"https://esphome.io/\">ESPHome</a> which is a really nice declarative way to wire up components just using YAML.</p>\n<p>However this project wasn’t using either, but I did spot there was a <code class=\"language-text\">platformio.ini</code> file. That means this repo is a <a href=\"https://platformio.org/\">PlatformIO</a> project: effectively a VS Code extension to compile, debug, test and upload code to various IoT devices. It’s new to me but looks pretty nice, and I look forward to trying it out more in the future.</p>\n<p><em>Setting up VSCode and PlatformIO are straightforward so I’ll leave Google to handle that for you.</em></p>\n<p>Finally, you need to configure some private variables as part of the build:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/// Private.h</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">secret_wifi_ssid</span> <span class=\"token string\">\"your wifi ssid\"</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">secret_wifi_password</span> <span class=\"token string\">\"your wifi password\"</span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">secret_mqtt_server</span> <span class=\"token string\">\"ip of your mqtt server\"</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">secret_clientName</span> <span class=\"token string\">\"whatever unique client name you want to use\"</span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">secret_mqtt_username</span> <span class=\"token string\">\"your mqtt user\"</span> <span class=\"token comment\">// or leave blank if not using</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">secret_mqtt_password</span> <span class=\"token string\">\"your mqtt pass\"</span> <span class=\"token comment\">// or leave blank if not using</span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">secret_local_timeclock_server</span> <span class=\"token string\">\"pool.ntp.org\"</span></span>\n\n<span class=\"token comment\">// Change these define according to your hardware</span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">METER_YEAR</span> <span class=\"token expression\"><span class=\"token number\">20</span> </span><span class=\"token comment\">// last two digits (e.g. 2019 is 19)</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">METER_SERIAL</span> <span class=\"token expression\"><span class=\"token number\">123456</span> </span><span class=\"token comment\">// your 6 digit serial</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FREQUENCY</span> <span class=\"token expression\"><span class=\"token number\">433.700007</span> </span><span class=\"token comment\">// you can test for this using the test code in everblu-meters-esp8266.cpp</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">GDO0</span> <span class=\"token expression\"><span class=\"token number\">5</span> </span><span class=\"token comment\">//header 11 </span></span></code></pre></div>\n<p>We’ve not set up MQTT yet. More on this below - just come back to this config file once you’re ready.</p>\n<h1>Problem 2: Finding the right frequency</h1>\n<p>OK so now we can compile the code, we need to find the correct frequency. I mentioned before the transceiver works on 433MHz, but you need to calibrate it to work on the EXACT frequency to be a little lower/higher against your meter.</p>\n<p>I’ll defer this step back to the <a href=\"https://github.com/AdrianLThomas/everblu-meters-esp8266-improved?tab=readme-ov-file#frequency-adjustment\">repo instructions</a>, but effectively there are some debug statements that you can uncomment that will write out to the serial monitor. Once you’ve found the correct one you can update your configuration accordingly (as per the snippet in the previous section).</p>\n<h1>Problem 3: Setting up MQTT</h1>\n<p>I’ll also gloss over this step too, but for me this was just a simple case of adding another container to my Docker Compose setup. I used <a href=\"https://hub.docker.com/_/eclipse-mosquitto\">Eclipse Mosquitto</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">mosquitto</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> eclipse<span class=\"token punctuation\">-</span>mosquitto<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> mosquitto\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"1883:1883\"</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /your<span class=\"token punctuation\">-</span>config<span class=\"token punctuation\">-</span>path/mosquitto/config<span class=\"token punctuation\">:</span>/mosquitto/config\n      <span class=\"token punctuation\">-</span> /your<span class=\"token punctuation\">-</span>config<span class=\"token punctuation\">-</span>path/mosquitto/data<span class=\"token punctuation\">:</span>/mosquitto/data\n      <span class=\"token punctuation\">-</span> /your<span class=\"token punctuation\">-</span>config<span class=\"token punctuation\">-</span>path/mosquitto/log<span class=\"token punctuation\">:</span>/mosquitto/log</code></pre></div>\n<h1>Problem 4: Device not being auto discovered in HA</h1>\n<p>The final issue I ran into was that the device was not being detected by HA.</p>\n<ol>\n<li>When connecting to the serial monitor, the device was connecting to the meter OK and outputting the data</li>\n<li>I could see that the ESP8266 had an IP address, so it must be connecting to the wifi fine</li>\n<li>Viewing the Mosquitto container logs showed that messages were being received as expected from the esp8266</li>\n<li>Manually subscribing to all topics (<code class=\"language-text\">#</code>) in HA showed that messages were being received correctly</li>\n</ol>\n<p>..yet no device appeared in HA</p>\n<p>I enabled ‘debug logging’ for MQTT in HA:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cbe0410e4869f1e4c6e99309f0770fad/2e237/debugging-mqtt-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.65822784810127%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABnklEQVQ4y5WSS27bQBBEeQKJkij+PzPDn4ciaQqUV4K9yym09iInMBwdvuJqmAISJJC9KDSHzX5TNUNHaY1hGDCOI06nEzprkSQJlFJgb55PKMtS3mVZhjRNpf5L7DkcOhwOaNsWTV3DGCPDURSJCI7jGH4QIAgC+L6P/X4vlfI8D7vdTp7Zdwjo+wGlMQjD8AZbr9ei1Wol1XVdEQHsL4AlDWe32y0cbQysteKClikObDabP0QYnXiBh9cfr3j/+Y63X2+4Xq+4XC6Skps5VVVhGEYUeS67LUAC/gbSATcezYj5ccY8zzifz3JMdCmRtTY4Tkc5+MXl/4CsRVHA1CVsZ9F1nawZl3fAeacolNjVWt8FUvyuqmo5pjzPb7fLZ4IdNsdhlBf3IlOMxmPq+/6WinM3IBcL6B6QVSsloKZpBLzM0bkAl5u9C/yE8gKaphWHj9Mka7rkBpz7MnDzGdlohYe6gW1bUcrIUYT2u0A63Lku5rrGk7V4nibRy3TEVJboswz6u5G3vJQwhI5jGCpJUKUpVBSh8H2EHz/2b7yxW2xM49E6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"enabling debug logging for mqtt\"\n        title=\"enabling debug logging for mqtt\"\n        src=\"/static/cbe0410e4869f1e4c6e99309f0770fad/f058b/debugging-mqtt-1.png\"\n        srcset=\"/static/cbe0410e4869f1e4c6e99309f0770fad/c26ae/debugging-mqtt-1.png 158w,\n/static/cbe0410e4869f1e4c6e99309f0770fad/6bdcf/debugging-mqtt-1.png 315w,\n/static/cbe0410e4869f1e4c6e99309f0770fad/f058b/debugging-mqtt-1.png 630w,\n/static/cbe0410e4869f1e4c6e99309f0770fad/2e237/debugging-mqtt-1.png 790w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>and looked at the <em>system</em> logs.</p>\n<p><em>💡 Tip: this is NOT the activity logbook, but the logs under Settings > System > Logs</em></p>\n<p>I could then see what the error was:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Logger: homeassistant.components.mqtt.entity\nSource: components/mqtt/entity.py:155\nintegration: MQTT (documentation, issues)\nFirst occurred: 02:11:02 (19 occurrences)\nLast logged: 10:38:09\n\n    Error 'extra keys not allowed @ data['device']['support_url']' when processing MQTT discovery message topic: 'homeassistant/sensor/water_meter_wifi_bssid/config', message: '{'unique_id': 'water_meter_wifi_bssid', 'object_id': 'water_meter_wifi_bssid', 'icon': 'mdi:access-point-network', 'qos': '0', 'state_topic': 'everblu/cyble/bssid', 'force_update': 'true', 'entity_category': 'diagnostic', 'device': {'identifiers': ['14071984'], 'model': 'Itron EverBlu Cyble Enhanced Water Meter ESP8266/ESP32', 'manufacturer': 'Psykokwak [Forked by Genestealer]', 'support_url': 'https://github.com/genestealer/everblu-meters-esp8266-improved', 'suggested_area': 'Home', 'name': 'Water Meter'}, 'name': 'WiFi BSSID'}'\n    Error 'expected SensorDeviceClass or one of 'date', 'enum', 'timestamp', 'apparent_power', 'aqi', 'area', 'atmospheric_pressure', 'battery', 'blood_glucose_concentration', 'carbon_monoxide', 'carbon_dioxide', 'conductivity', 'current', 'data_rate', 'data_size', 'distance', 'duration', 'energy', 'energy_distance', 'energy_storage', 'frequency', 'gas', 'humidity', 'illuminance', 'irradiance', 'moisture', 'monetary', 'nitrogen_dioxide', 'nitrogen_monoxide', 'nitrous_oxide', 'ozone', 'ph', 'pm1', 'pm10', 'pm25', 'power_factor', 'power', 'precipitation', 'precipitation_intensity', 'pressure', 'reactive_power', 'signal_strength', 'sound_pressure', 'speed', 'sulphur_dioxide', 'temperature', 'volatile_organic_compounds', 'volatile_organic_compounds_parts', 'voltage', 'volume', 'volume_storage', 'volume_flow_rate', 'water', 'weight', 'wind_direction', 'wind_speed' for dictionary value @ data['device_class']' when processing MQTT discovery message topic: 'homeassistant/sensor/water_meter_wifi_status/config', message: '{'unique_id': 'water_meter_wifi_status', 'object_id': 'water_meter_wifi_status', 'device_class': 'connectivity', 'qos': '0', 'state_topic': 'everblu/cyble/status', 'force_update': 'true', 'entity_category': 'diagnostic', 'device': {'identifiers': ['14071984'], 'model': 'Itron EverBlu Cyble Enhanced Water Meter ESP8266/ESP32', 'manufacturer': 'Psykokwak [Forked by Genestealer]', 'support_url': 'https://github.com/genestealer/everblu-meters-esp8266-improved', 'suggested_area': 'Home', 'name': 'Water Meter'}, 'name': 'WiFi Status'}'\n    Error 'extra keys not allowed @ data['device']['support_url']' when processing MQTT discovery message topic: 'homeassistant/sensor/water_meter_uptime/config', message: '{'unique_id': 'water_meter_uptime', 'object_id': 'water_meter_uptime', 'device_class': 'timestamp', 'qos': '0', 'state_topic': 'everblu/cyble/uptime', 'force_update': 'true', 'entity_category': 'diagnostic', 'device': {'identifiers': ['14071984'], 'model': 'Itron EverBlu Cyble Enhanced Water Meter ESP8266/ESP32', 'manufacturer': 'Psykokwak [Forked by Genestealer]', 'support_url': 'https://github.com/genestealer/everblu-meters-esp8266-improved', 'suggested_area': 'Home', 'name': 'Water Meter'}, 'name': 'Device Uptime'}'\n    Error 'extra keys not allowed @ data['device']['support_url']' when processing MQTT discovery message topic: 'homeassistant/sensor/water_meter_wifi_signal_percentage/config', message: '{'unique_id': 'water_meter_wifi_signal_percentage', 'object_id': 'water_meter_wifi_signal_percentage', 'device_class': 'signal_strength', 'icon': 'mdi:wifi', 'unit_of_measurement': '%', 'qos': '0', 'state_topic': 'everblu/cyble/wifi_signal_percentage', 'force_update': 'true', 'entity_category': 'diagnostic', 'device': {'identifiers': ['14071984'], 'model': 'Itron EverBlu Cyble Enhanced Water Meter ESP8266/ESP32', 'manufacturer': 'Psykokwak [Forked by Genestealer]', 'support_url': 'https://github.com/genestealer/everblu-meters-esp8266-improved', 'suggested_area': 'Home', 'name': 'Water Meter'}, 'name': 'WiFi Signal'}'\n    Error 'extra keys not allowed @ data['device']['support_url']' when processing MQTT discovery message topic: 'homeassistant/sensor/water_meter_value/config', message: '{'unique_id': 'water_meter_value', 'object_id': 'water_meter_value', 'icon': 'mdi:water', 'unit_of_measurement': 'L', 'device_class': 'water', 'state_class': 'total_increasing', 'qos': 0, 'state_topic': 'everblu/cyble/liters', 'force_update': True, 'device': {'identifiers': ['14071984'], 'model': 'Itron EverBlu Cyble Enhanced Water Meter ESP8266/ESP32', 'manufacturer': 'Psykokwak [Forked by Genestealer]', 'support_url': 'https://github.com/genestealer/everblu-meters-esp8266-improved', 'suggested_area': 'Home', 'name': 'Water Meter'}, 'name': 'Reading (Total)'}'</code></pre></div>\n<p>As you can see there are some errors regarding the <code class=\"language-text\">support_url</code> field. Removing this invalid field in the schema (and some other minor tweaks) in the PR resolved the issue and the device became available in HA! 🎉</p>\n<h1>Result, and what next?</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7f84278fd76bf7800a8cd1012ee359c0/5b4a1/water-meter-ha.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.16455696202532%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC3UlEQVQ4y51UWXLqMBDkBIEEvEiy5E3ybiAYTKhU7n+sfjVjDAHy9T6mSsuoNdPd0uJ4PGIYDsjyDFJKREoiiqL/jsV6vcYUH1h7HtaBwLz28fFxi3ve+s/9OWexWq3AsVzi3fOxkgbv7+9TwmbzAkB7FDTf/N7fbHh9MScsl0voKMJ4HDAcBnRdyxQopW5B8+FwwDiOSJIEQghejyIFrRR8338EJA52ux1H0zSw1sI5h6IooLWGkBK5q1BVFa/RPgGrSEOl+Ssg3dZte/Rdj7pu+BAdpoNUnZQKJk5ROIu6rqZL8xzKxFCufgJcLSF9CStyZFn6p4JhGCJMHfysgm9bBCaDCEMookYIeJ53B1wRYKBgkxa2brjFGYjGJo4RBCG0iaGNgVQRU0A8UlAHJNIvwBW8IECQOfgmvyVN3lSIrmMSZBgGxHF8FeTewUPLBEgLpLTRU1UEym0KCT8yEMRhalEUjoUjwQiUuOy6DkEQPNlGaxxPJ4znM87nM4uRJjFSW0D1RxYlzhwK5x4qpIvzPOfLb4Bvb29sgZ+fH3x/f+NEwOOIr68vnndtA6E00rJHVZbsAKYjihiMqnypkG6q65pboWrnMEZDhgGEipAWLaqq5BaNMVxllmUoy/IRkDikBTaqUjyewkcQCvhkESFhMstUlFV1y6VKCfxPDi+XC6s4vxDiq2haJLtxMnaSoS4LbLsW7mp4Mj9V/KDyzOEMSBySMF+XC8bTCbttP73drIC0FaRroJKcLTWL82IbUilmAwc3w3KQdXyPDwRKw1cGvk54THuc85exCdBdLcGHZw6FgpeWfPBzt8VpGHA8fMLZnGmYjf/yORCxZBtqtW1bbLdb9F2Hfv8J93lmUWxZY7/bgX56ulxKwZ+DfP4ciMM0TZnD/X6Pw+Fw45LGXVNzWzq1MGmGxDqYOJmq0wbR8/c1P735kT+E53EQBSovIWyNsOghUzsBqvsH+w+HqTNu+nnx6QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A screenshot of the water meter in Home Assistant\"\n        title=\"A screenshot of the water meter in Home Assistant\"\n        src=\"/static/7f84278fd76bf7800a8cd1012ee359c0/f058b/water-meter-ha.png\"\n        srcset=\"/static/7f84278fd76bf7800a8cd1012ee359c0/c26ae/water-meter-ha.png 158w,\n/static/7f84278fd76bf7800a8cd1012ee359c0/6bdcf/water-meter-ha.png 315w,\n/static/7f84278fd76bf7800a8cd1012ee359c0/f058b/water-meter-ha.png 630w,\n/static/7f84278fd76bf7800a8cd1012ee359c0/5b4a1/water-meter-ha.png 831w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Now I just need to tidy up those wires and 3D print a tidy little case to hide it away in the pantry.</p>\n<p>You can find my <a href=\"https://github.com/AdrianLThomas/everblu-meters-esp8266-improved\">fork here</a> or if you prefer to view the diff see the <a href=\"https://github.com/genestealer/everblu-meters-esp8266-improved/pull/3\">PR to the maintainer here</a>.</p>","frontmatter":{"title":"Reading my water meter in Home Assistant","date":"March 17, 2025","description":"Water bills in the UK are going up, again, and I thought it would be nice to keep a closer eye on the household usage by integrating the water meter in to Home Assistant. Learn how I used an ESP8266 and CC1101 to read from an Irton EverBlu Cyble water meter, and some of the problems I hit along the way."}},"previous":{"fields":{"slug":"/blog/2025-03-11/running-postgres-in-the-browser/"},"frontmatter":{"title":"Running Postgres 100% in the browser with PGlite and Drizzle"}},"next":null},"pageContext":{"id":"02f68190-7ca3-5092-a4bb-384e05a9ddb8","previousPostId":"3b3f9268-82f3-5326-b0ff-802bcc4343db","nextPostId":null}},
    "staticQueryHashes": ["2188205249","223224310","2441407101"]}