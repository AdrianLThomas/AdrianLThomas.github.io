{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/blog/2025-03-10/running-postgres-in-the-browser/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Adrian L Thomas"}},"markdownRemark":{"id":"f5bbb4bb-0ac9-5007-93c5-af1091e77e71","excerpt":"tl;dr You can run Postgres 100% in the browser with PGlite. This post walks through setting it up with Vite (React), handling migrations in the client, and…","html":"<h1>tl;dr</h1>\n<p>You can run Postgres 100% in the browser with PGlite. This post walks through setting it up with Vite (React), handling migrations in the client, and overcoming common pitfalls. Includes a working <a href=\"http://www.adrian-thomas.com/pglite-spa\">demo</a> and <a href=\"https://github.com/AdrianLThomas/pglite-spa\">GitHub repo</a>.</p>\n<h1>Intro</h1>\n<p>I’ve been playing around with <a href=\"https://pglite.dev/\">PGlite</a> (<a href=\"https://www.postgresql.org/\">Postgres</a> <a href=\"https://developer.mozilla.org/en-US/docs/WebAssembly\">WASM</a>), and it’s pretty cool. There are some gotchas, so I’ll run through how I got PGlite running with <a href=\"https://vite.dev/\">Vite</a> (React) and <a href=\"https://orm.drizzle.team/\">Drizzle</a> (ORM).</p>\n<h1>Getting setup</h1>\n<p>Run the Vite scaffolder with your favourite package manager (I’ll continue to use Bun, but feel free to use npm/yarn/pnpm etc)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bun create vite</code></pre></div>\n<p>and follow the steps to create a new React project.</p>\n<p>You can then add PGlite:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bun <span class=\"token function\">add</span> @electric-sql/pglite</code></pre></div>\n<h2>Gotcha #1 - Exclude PGlite from the bundle</h2>\n<p>Some bundlers (like Vite and Next.js) struggle with PGlite, and it will error with something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Uncaught Error: Invalid FS bundle size: 723 !== 5401749</code></pre></div>\n<p>so <a href=\"https://pglite.dev/docs/bundler-support#vite\">exclude it from optimisation</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// vite.config.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> defineConfig <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"vite\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> react <span class=\"token keyword\">from</span> <span class=\"token string\">\"@vitejs/plugin-react\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">defineConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">react</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  optimizeDeps<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    exclude<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"@electric-sql/pglite\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>PGlite 101</h2>\n<p>We’re now in a position to make a Postgres query!</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">/// App.tsx</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useEffect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> PGlite <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@electric-sql/pglite\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> drizzle <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"drizzle-orm/pglite\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PGlite</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"idb://my-pgdata\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> db <span class=\"token operator\">=</span> <span class=\"token function\">drizzle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> client <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    db<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>\n      <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">select 1;</span><span class=\"token template-punctuation string\">`</span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> sql <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Markup omitted for brevity...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>We’re using <code class=\"language-text\">idb://my-pgdata</code> when instantiating the client to use persistent browser storage. However there are also <a href=\"https://pglite.dev/docs/filesystems#filesystems\">other storage options</a> available.</p>\n<h2>Types, schema &#x26; migrations with Drizzle</h2>\n<p>You can probably skip this part if you don’t want / need to use an ORM and are happy with arbitrary SQL. However if you’d like types and the ability to migrate between schemas, please continue…</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bun <span class=\"token function\">add</span> drizzle-orm <span class=\"token comment\"># Lets us define the schema and gives us types</span>\nbun <span class=\"token function\">add</span> -d drizzle-kit <span class=\"token comment\"># Helpful for migrations</span></code></pre></div>\n<p>You can then <a href=\"https://orm.drizzle.team/docs/sql-schema-declaration\">create a schema with Drizzle</a>. For this example let’s just create a simple TODO table:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">/// src/app/db/schema.ts</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n    pgTable<span class=\"token punctuation\">,</span>\n    serial<span class=\"token punctuation\">,</span>\n    varchar<span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">,</span>\n    timestamp<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"drizzle-orm/pg-core\"</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> todos <span class=\"token operator\">=</span> <span class=\"token function\">pgTable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"todos\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token function\">serial</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">primaryKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    content<span class=\"token operator\">:</span> <span class=\"token function\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> length<span class=\"token operator\">:</span> <span class=\"token number\">255</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    completed<span class=\"token operator\">:</span> <span class=\"token function\">boolean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"completed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">default</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    createdAt<span class=\"token operator\">:</span> <span class=\"token function\">timestamp</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"created_at\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">defaultNow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Drizzle will provide us with some nice types based on this.</p>\n<h2>Gotcha #2 - How do you run migrations in the browser?</h2>\n<p>The <a href=\"https://orm.drizzle.team/docs/get-started/pglite-new\">PGlite / Drizzle get started guide</a> is great, but it assumes you’re running PGlite on the server. Thus there are some differences (and unfortunately an undocumented API we need to use..).</p>\n<p>Create a Drizzle config file:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span> Config <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"drizzle-kit\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n  schema<span class=\"token operator\">:</span> <span class=\"token string\">\"./src/app/db/schema.ts\"</span><span class=\"token punctuation\">,</span>\n  out<span class=\"token operator\">:</span> <span class=\"token string\">\"./src/app/db/migrations\"</span><span class=\"token punctuation\">,</span>\n  dialect<span class=\"token operator\">:</span> <span class=\"token string\">\"postgresql\"</span><span class=\"token punctuation\">,</span>\n  driver<span class=\"token operator\">:</span> <span class=\"token string\">\"pglite\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> satisfies Config<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Generate the migration:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">npx drizzle-kit generate <span class=\"token comment\"># generates the SQL files to perform a migration</span></code></pre></div>\n<p>Ordinarily you would now run <code class=\"language-text\">npx drizzle-kit migrate</code>, HOWEVER: you’re not on the server, you’re on the client! so this is never going to work. How do you run the migration in the browser?</p>\n<h3>Compile offline migrations</h3>\n<p>Thankfully I came across a very <a href=\"https://github.com/drizzle-team/drizzle-orm/discussions/2532\">helpful post on GitHub</a> by <a href=\"https://github.com/daltonkyemiller\">@daltonkyemiller</a>. They found an undocumented API that where we can take our generated SQL migration and convert it in to the JSON format required to run it against PGlite.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// You could execute this standalone script with Bun like so:</span>\n<span class=\"token comment\">// drizzle-kit generate &amp;&amp; bun ./src/app/db/compile-migrations.ts</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> readMigrationFiles <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"drizzle-orm/migrator\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> path <span class=\"token keyword\">from</span> <span class=\"token string\">\"path\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> migrationsFolder <span class=\"token operator\">=</span> <span class=\"token string\">\"./src/app/db/migrations\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> migrations <span class=\"token operator\">=</span> <span class=\"token function\">readMigrationFiles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> migrationsFolder <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">await</span> Bun<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>\n  path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>migrationsFolder<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/migrations.json</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>migrations<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Migrations compiled!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We now have a <code class=\"language-text\">migrations.json</code> file that can be used in the browser.</p>\n<p>🚨 <em>Unfortunately, as the functions are undocumented, the Drizzle team could break them any point in time. Unfortunately if you want to use Drizzle in the browser then there is no alternative at the time of writing.</em></p>\n<h3>Executing the migration</h3>\n<p>Setup the migration:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">/// src/app/db/migrate.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span> MigrationConfig <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"drizzle-orm/migrator\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> db <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./drizzle\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> migrations <span class=\"token keyword\">from</span> <span class=\"token string\">\"./migrations/migrations.json\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">migrate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// @ts-ignore</span>\n  db<span class=\"token punctuation\">.</span>dialect<span class=\"token punctuation\">.</span><span class=\"token function\">migrate</span><span class=\"token punctuation\">(</span>migrations<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    migrationsTable<span class=\"token operator\">:</span> <span class=\"token string\">\"drizzle_migrations\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> satisfies Omit<span class=\"token operator\">&lt;</span>MigrationConfig<span class=\"token punctuation\">,</span> <span class=\"token string\">\"migrationsFolder\"</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>and simply execute the exported <code class=\"language-text\">migrate</code> function, e.g.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// root.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> migrate <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./migrate\"</span>\n\n<span class=\"token function\">migrate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>renderApp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>I’ve provided an example repo at the end of this post showing how I executed the migration wrapped in <a href=\"https://react.dev/reference/react/Suspense\">Suspense</a> so that a placeholder is shown during initialisation.</p>\n<h1>Basic CRUD operations</h1>\n<p>It’s just Drizzle all the way forward now, there’s a bunch of <a href=\"https://orm.drizzle.team/docs/rqb\">documentation</a>, but here’s some examples sticking with the TODO theme:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">/// src/app/db/actions.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">fetchAllTodos</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>todos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span>todos<span class=\"token punctuation\">.</span>createdAt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">addTodoAction</span><span class=\"token punctuation\">(</span>formData<span class=\"token operator\">:</span> FormData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> todo<span class=\"token operator\">:</span> <span class=\"token keyword\">typeof</span> todos<span class=\"token punctuation\">.</span>$inferInsert <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    content<span class=\"token operator\">:</span> formData<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> inserted <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>todos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span>todo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">returning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> inserted<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">deleteTodoAction</span><span class=\"token punctuation\">(</span>formData<span class=\"token operator\">:</span> FormData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>formData<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> deleted <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>todos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>todos<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">returning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> deleted<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1>Getting data in and out</h1>\n<p>There’s a number of options depending on what the use-case is, but I’ll describe an approach I took. If you just want test data, you can use <a href=\"https://orm.drizzle.team/docs/seed-overview\">drizzle-seed</a>.</p>\n<h2>CSV</h2>\n<p>One option to import data is with a CSV. Given it’s running in the browser, you need to be able to obtain the CSV as a blob. This is then mapped to <a href=\"https://pglite.dev/docs/api#dev-blob\">PGlite’s virtual device</a> <code class=\"language-text\">/dev/blob</code>, and then you can just copy the data like you ordinarily would with SQL:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// example depicting the copying of citizen data from a CSV in to the citizens table.</span>\n\n<span class=\"token keyword\">const</span> csvResponse <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/smart_city_citizen_activity.csv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  COPY citizens(id, age, gender, mode_of_transport)\n  FROM '/dev/blob'\n  DELIMITER ','\n  CSV HEADER;\n  </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  blob<span class=\"token operator\">:</span> <span class=\"token keyword\">await</span> csvResponse<span class=\"token punctuation\">.</span><span class=\"token function\">blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><em>If you’re storing your data in IndexedDB then you’ll also want to query if the data has already been imported before doing so (to avoid doing so on each load!).</em></p>\n<h2>Alternatives</h2>\n<p>PGlite also supports exporting to a tarball with <a href=\"https://pglite.dev/docs/api#dumpdatadir\">dumpDataDir</a>, and importing with <a href=\"https://pglite.dev/docs/api#options\">loadDataDir</a>. Here you can provide an <a href=\"https://pglite.dev/examples/dump-data-dir\">(example of both)</a></p>\n<h1>SQL Client</h1>\n<p>You might be tempted to reach for your favourite Postgres client (and/or Drizzle Studio). Unfortunately you cannot use it (there’s no endpoint to connect to!).</p>\n<p>One option would be to export and re-import elsewhere to a server Postgres instance.</p>\n<p>However, there is a REPL that PGlite provides that let’s you query directly in the browser. It’s just a <a href=\"https://pglite.dev/docs/repl\">React component (web component also available)</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Repl <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@electric-sql/pglite-repl\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">...</span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Repl</span></span> <span class=\"token attr-name\">pg</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>client<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>There’s even a <a href=\"https://pglite.dev/repl/\">live demo of the REPL here</a>.</p>\n<h3>Gotcha #3 - You’re at the mercy of dependencies</h3>\n<p>When I was setting up what seemed to be a simple React component for the REPL, I got an error:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Uncaught Error: No CodeMirror editor found</code></pre></div>\n<p>I raised an <a href=\"https://github.com/electric-sql/pglite/issues/559\">issue on GitHub</a> and <a href=\"https://github.com/ldirer\">@ldirer</a> found out it’s related to a change in the CodeMirror dependency itself.</p>\n<p>If you’re seeing this issue, the workaround at the time of writing is to override to an older version of React CodeMirror:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"overrides\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"@uiw/react-codemirror\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4.23.5\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<h1>Code &#x26; Demo</h1>\n<p>The repo with the <a href=\"https://github.com/AdrianLThomas/pglite-spa\">code can be found here</a>: it shows most things discussed in this post.</p>\n<p>You can also see a <a href=\"http://www.adrian-thomas.com/pglite-spa\">live demo of the working code here</a>.</p>\n<p>Thanks for reading!</p>","frontmatter":{"title":"Running Postgres 100% in the browser with PGlite and Drizzle","date":"March 11, 2025","description":"You can run Postgres 100% in the browser client, I'll describe how, why and share some of the pros and cons of doing so."}},"previous":{"fields":{"slug":"/blog/2022-09-27/writing-user-focused-tickets/"},"frontmatter":{"title":"Writing user focused tickets that enable continuous flow"}},"next":{"fields":{"slug":"/blog/2025-03-11/running-postgres-in-the-browser/"},"frontmatter":{"title":"Running Postgres 100% in the browser with PGlite and Drizzle"}}},"pageContext":{"id":"f5bbb4bb-0ac9-5007-93c5-af1091e77e71","previousPostId":"05cea427-4bb1-551b-af26-248ef61e687d","nextPostId":"3b3f9268-82f3-5326-b0ff-802bcc4343db"}},
    "staticQueryHashes": ["2188205249","223224310","2441407101"]}