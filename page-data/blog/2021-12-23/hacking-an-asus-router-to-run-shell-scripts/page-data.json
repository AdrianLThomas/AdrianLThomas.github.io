{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/blog/2021-12-23/hacking-an-asus-router-to-run-shell-scripts/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Adrian L Thomas"}},"markdownRemark":{"id":"1881dd6e-f671-5ccb-a492-04e9a08f3988","excerpt":"Asus routers let you SSH in to them for remote management. In this post you’ll learn how to run a shell command to run any scripts you want (e.g. routine backup…","html":"<p>Asus routers let you SSH in to them for remote management. In this post you’ll learn how to run a shell command to run any scripts you want (e.g. routine backup scripts).</p>\n<p>I wanted to backup some files on an external disk attached to the router, and store them in DropBox. It’s possible by SSH’ing in to the router, writing the script to flash memory (so it isn’t erased on reboot), and configuring it to run when a USB device is connected.</p>\n<p>First, navigate to your router admin page, go to the Administration Settings and enable login via SSH. It will look something like this:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c9339882218731f4c604e160f46e4d77/ffe34/router-ssh-config.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 87.34177215189874%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADDElEQVQ4y12SS2/iVhiGzSbRVGpVddFFMrtKHY2Gi7kZsI2NjS9gsHECmGObY2yDb8eAmUmAhkx/Qpf9vy2kjTIjPYuzefS+3/cdrEDQvNxnBSmPV7oDzU2z8WKpmnAI5ka49XYHM9mCeGP+D4jWcPOF7mu3nwiM4CR9Bgb3kxbDcX3VSTZ3tiuPQVebmPF6vn2YhmgWoWmYvjAJkIkysqfe5gmsISrKaNSiyFKl/BGvVtqd30vVD+X6b4WSOLWMJFMsqwcm/MTkLnTGQDBsnBXeFxoYBzPvz7/h8S8BPkqje3e9023vDvr63IPpLnh8slFmJlsL/YeZbN3dY1sZ3ZxrK0BxNoKxxNkBIyuTxZLX7nltzA50I0DB8Xm5fwqPX1eH59X+5D38AVA2jTcteXiuXedlSel1+E6xXPpUrZNijxZ7dYb/gNckwxoHiRGlRryZBEj3w/tVMoS+aDrljniu/eMvv15dXV+/++Hq+rpINGlZITpCje0WCFJzlt7j0wxlAO1ml0AjyYaLlQL9Ki+/zzewdz/9jGEYlsthGFaoN5nesEyxxVa7QJCq7QKU3flR33ZfkQDsQ7/KSd/LeJPih3qF7uAUW2xQirUAKDMjX4W2BBzZPCOZziX5rYyd5XyN4AYaJfSKTepjlZAMZxxluhuM3EACUDBswbC7U0u2nMrLzC9y7pLcVXUn3U28QIe+ai5stIW7o5VmJtq+ApINzB5o5fLD3sp8VzLnnqhovYEu9zXbi9z13lolMy8EfvTCzAthmDLi4Hyqt7Vb5RrTEYoVokKQxXJdB9DffB6CuWJYr/SnpgZgu83fFr5dGEm0mL5a6wglis03ac2B1joewpnqgNFipjrnxwCC/tylWeGNfPFreLXFyzWGL11OpQBoxDsjQPfLZBKgaYCmIRqvklmU8l355rttN8p1WlJwksVJptCg7hw/Op7C/Sk+fo0Op/h4ig/P0eE53j/JonLzzcy5XLNc63Jiq0lTJNMgyJm1SHf7JI2DOHYD5IepFyI3SJZRynHSv8n/AFcyG1qmONNYAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Router SSH Config\"\n        title=\"Router SSH Config\"\n        src=\"/static/c9339882218731f4c604e160f46e4d77/f058b/router-ssh-config.png\"\n        srcset=\"/static/c9339882218731f4c604e160f46e4d77/c26ae/router-ssh-config.png 158w,\n/static/c9339882218731f4c604e160f46e4d77/6bdcf/router-ssh-config.png 315w,\n/static/c9339882218731f4c604e160f46e4d77/f058b/router-ssh-config.png 630w,\n/static/c9339882218731f4c604e160f46e4d77/40601/router-ssh-config.png 945w,\n/static/c9339882218731f4c604e160f46e4d77/ffe34/router-ssh-config.png 1055w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Then SSH in to it. The router is running BusyBox which is a very lightweight Linux executable used for embedded systems. It gives you some very basic utilities [1] (sorry, don’t even expect nano!).</p>\n<p>The filesystem is running in RAM, which obviously resets on reboot. However, if we write to the <code class=\"language-text\">/jffs</code> path, it will be written to flash memory - this is perfect to persist a script that could run on boot.</p>\n<p>There is one problem, if this is the only area we can persist data, how do we actually run a script on boot? Well, we can write to NVRAM (non-volatile RAM). NVRAM is stores key/value pairs, such as your WiFi password, public SSH keys, SSID, etc. but we can use it to set a small command that runs when a USB device is mounted (e.g. on boot) [2].</p>\n<p>Here are some of the WiFi settings if you grep the <code class=\"language-text\">nvram show</code> command:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/58ff8f9c60640f2213a39ba1900802d9/0d6fe/wifi-settings.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.278481012658226%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAyElEQVQY03XJwWqEMBQF0JAELcYsJiLWjRhkJublaf/L6iL9BWlHwY8eSBhx07O43Hcfef79btu27/txHOu6eu9/3rz336d5DjEvyzKHPk0TaZpGa911XVmWUsosyz6CNE2TJKGUcs4ZY9fCGOOcU0oJAHwFAGCMsdb2fQ8A1loAcM4hYizDMDjn4o6IWmtirUXEc42MMY/gHmitjTH3t7jXdU0QcRzHtm2rqvoMlFJCiOwf50sIQYqiuF0opaSUeZ7Li3heM5YXHFM3vDbeEO8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"nvram show\"\n        title=\"nvram show\"\n        src=\"/static/58ff8f9c60640f2213a39ba1900802d9/f058b/wifi-settings.png\"\n        srcset=\"/static/58ff8f9c60640f2213a39ba1900802d9/c26ae/wifi-settings.png 158w,\n/static/58ff8f9c60640f2213a39ba1900802d9/6bdcf/wifi-settings.png 315w,\n/static/58ff8f9c60640f2213a39ba1900802d9/f058b/wifi-settings.png 630w,\n/static/58ff8f9c60640f2213a39ba1900802d9/40601/wifi-settings.png 945w,\n/static/58ff8f9c60640f2213a39ba1900802d9/0d6fe/wifi-settings.png 1115w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The magic parameter we want to set is <code class=\"language-text\">script_usbmount</code> to run a command when a USB device is mounted.</p>\n<p>So, putting it altogether, this is what it would look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> /jffs <span class=\"token comment\"># Change directory to flash memory</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"#!/bin/sh\"</span> <span class=\"token operator\">>></span> ./my-script.sh <span class=\"token comment\"># Append shell shebang to .my-script.sh in flash memory</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'while :; do echo \"do something\"; sleep 86400; done'</span> <span class=\"token operator\">>></span> ./my-script.sh <span class=\"token comment\"># append command</span>\n<span class=\"token function\">chmod</span> +x ./my-script.sh <span class=\"token comment\"># make the script executable</span>\nnvram <span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">script_usbmount</span><span class=\"token operator\">=</span><span class=\"token string\">\"sh /jffs/my-script.sh\"</span> <span class=\"token comment\"># set the parameter to execute when a USB device is mounted</span>\nnvram commit <span class=\"token comment\"># commit the parameter to non-volatile memory</span>\n<span class=\"token function\">service</span> <span class=\"token function\">reboot</span> <span class=\"token comment\"># reboot the router</span></code></pre></div>\n<p>I’m using echo with output redirection to write to a file called <code class=\"language-text\">my-script.sh</code>. I’m terrible with Vim (which <em>is</em> available) so this works well enough for me, but feel free to use Vim if you’re comfortable with it. I’ve excluded the actual backup script as that’s worthy of an entire blog post. In a nutshell, when a usb device is mounted the command in <code class=\"language-text\">script_usbmount</code> is executed.  It indefinitely loops, and echo’s <code class=\"language-text\">\"do something\"</code> then sleeps for 24 hours (<code class=\"language-text\">86400</code>s). Obviously this script could contain any code you wanted to reasonably run.</p>\n<p>That’s it!</p>\n<p>Sources:</p>\n<ol>\n<li><a href=\"https://www.busybox.net/downloads/BusyBox.html#commands\">https://www.busybox.net/downloads/BusyBox.html#commands</a></li>\n<li><a href=\"https://www.snbforums.com/threads/how-to-run-cron-and-other-scripts-on-startup.69063/#post-648945\">https://www.snbforums.com/threads/how-to-run-cron-and-other-scripts-on-startup.69063/#post-648945</a></li>\n</ol>","frontmatter":{"title":"Hacking an Asus router to run regular shell scripts on boot","date":"December 23, 2021","description":"Asus routers let you SSH in to them for remote management. You'll learn how to write a shell script in flash memory to run any scripts you want, when you want."}},"previous":{"fields":{"slug":"/blog/2021-10-30/golang-for-the-node-guy/"},"frontmatter":{"title":"Golang for the Node Guy"}},"next":{"fields":{"slug":"/blog/2021-12-24/hacking-an-asus-router-to-run-shell-scripts/"},"frontmatter":{"title":"Running curl in BusyBox"}}},"pageContext":{"id":"1881dd6e-f671-5ccb-a492-04e9a08f3988","previousPostId":"2da8c302-543a-588e-b5e6-45099bdc24e6","nextPostId":"36150032-737d-5c23-9f85-287d7143ace6"}},
    "staticQueryHashes": ["2188205249","223224310","24654591"]}